## Домашнее задание №7 «Логирование обращений в методы через Kafka»

### Цель:
Вывести события по обращениям в методы сервиса в очередь сообщений, используя Kafka и паттерн `transactional-outbox`.

### Основное задание:
1. Добавить Apache Kafka и её компоненты в Docker-окружение, включая:
    - контейнер с брокером `confluentinc/cp-kafka`
    - контейнер с UI админкой на базе `provectuslabs/kafka-ui`
    - контейнер для инициализации окружения `confluentinc/cp-kafka` (используя `kafka-topics.sh`)

2. При старте контейнеризированного окружения должна создаваться очередь для событий, связанных с действиями в ПВЗ:
    - название очереди: `pvz.events-log`
    - фактор репликации: `1`
    - количество партиций: `1`

3. Доработать сервис так, чтобы при следующих действиях создавались события:
    - Принятие заказа от курьера (`POST /orders`) -> `order_accepted`
    - Возврат заказа курьеру (`DELETE /orders/{order_id}`) -> `order_returned_to_courier`
    - Выдача заказа клиенту (`POST /orders/process`) -> `order_issued`
    - Принятие возврата от клиента (`POST /orders/process`) -> `order_returned_by_client`

4. Сформированные события должны сохраняться в PostgreSQL в таблицу `outbox`, используя паттерн transactional-outbox.
    - Каждое событие сохраняется в момент бизнес-операции в рамках общей транзакции
    - Хранимое событие должно быть заранее сериализовано в JSON и сохраняться в колонку `payload`

5. Структура таблицы `outbox`:
    - `id UUID`
    - `payload JSONB`
    - `status` ENUM: `CREATED`, `PROCESSING`, `COMPLETED`, `FAILED`
    - `error TEXT` — заполняется при статусе `FAILED`
    - `created_at TIMESTAMP`
    - `sent_at TIMESTAMP`

6. Реализовать отдельный процесс (воркер), который:
    - выбирает задачи со статусом `CREATED`
    - помечает задачи как `PROCESSING`
    - отправляет событие в Kafka
    - при успехе → обновляет статус на `COMPLETED`, заполняет `sent_at`
    - при ошибке → обновляет статус на `FAILED`, заполняет `error`

7. Сформировать события в следующем JSON-формате:
```json
{
  "event_id": "uuid",
  "event_type": "order_accepted",
  "timestamp": "2025-04-22T15:03:05Z",
  "actor": {
    "type": "courier",
    "id": "int"
  },
  "order": {
    "id": "int",
    "user_id": "string",
    "status": "accepted"
  },
  "source": "pvz-api"
}
```

8. Покрыть код отправки сообщений Unit-тестами
9. В MR вложить скриншоты отправленных сообщений, полученных через `kafka-ui`

### Дополнительное задание:
- Для каждой задачи в outbox необходимо вести счётчик попыток:
    - В таблицу `outbox` добавить поля:
        - `attempts INT DEFAULT 0`
        - `last_attempt_at TIMESTAMP`
    - При каждой неуспешной отправке значение `attempts` увеличивается на 1, `last_attempt_at` обновляется
    - После неуспешной попытки задача должна быть недоступна для повторной обработки в течение 2 секунд (ориентируясь на `last_attempt_at`)
    - Максимум попыток: 3. После этого задача получает статус `FAILED`, а в поле `error` указывается причина `NO_ATTEMPTS_LEFT`

- Реализовать двухпроходный воркер:
    - Первый проход выбирает задачи со статусом `CREATED` и блокирует их, устанавливая `PROCESSING`
    - Второй проход обрабатывает задачи со статусом `PROCESSING` (в отдельной транзакции) и завершает их (`COMPLETED` или `FAILED`)

- Написать интеграционные тесты на взаимодействие с Kafka

- Разработать отдельный сервис `notifier` (отдельный бинарник), который:
    - добавлен в Docker-окружение(или ЧТО-ТО что работает паралельно вашему основному сервису и запускается вместе с ним)
    - подключается к Kafka и подписывается на `pvz.events-log`
    - логирует полученные события в stdout
    - использует consumer group и фиксирует смещения после успешной обработки
    - при рестарте начинает с последнего необработанного события
    - логирует ошибки обработки событий

- В MR вложить:
    - скриншоты сообщений из `kafka-ui`
    - скриншот логов из контейнера `notifier`


### Формальные валидации события:
- `event_id` — UUID
- `timestamp` — ISO8601 (UTC)
- `actor.type` — одно из: `client`, `courier`
- `actor.id`, `order.id`, `order.user_id` — обязательные параметры (прим: для курьера actor.id будет рандомным значением)
- `event_type` должен соответствовать `order.status`
- `source` — всегда `pvz-api`

### Дедлайны сдачи и проверки задания:
- 12 июля 23:59 (сдача) / 15 июля, 23:59 (проверка)

